<html xmlns="http://www.w3.org/1999/xhtml"><head><meta name="generator" content="LERSUS 3.3.0.0" /><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>Корпоративные информационные системы — Практика — Практика 3. Создание  и работа с триггерами объектов и событий</title><script language="javascript" type="text/javascript" src="../../00/styles/files/apiwrapper.js"> </script><script language="javascript" type="text/javascript" src="../../00/styles/files/sco.js"> </script><link href="../../00/styles/files/style.css" rel="stylesheet" type="text/css" /></head><body><table id="mainOuter"><tr><td id="topOuter"><table id="topInner"><tr class="row1"><td class="cell1"><div> </div></td><td class="cell2"><div> </div></td><td class="cell3"><div> </div></td><td class="cell4" id="shortcuts"><div><ul class="level0"><li><a href="../../00/content/authors1.html">Авторы</a></li><li>|</li><li><a href="../../00/content/contacts1.html">Контакты</a></li><li>|</li><li><a href="../../00/content/instructions1.html">Методические указания</a></li><li>|</li><li><a href="../../00/content/annotation1.html">Аннотация</a></li><li>|</li><li><a href="#" onclick="history.back(); return false;">Назад</a></li></ul></div></td></tr><tr class="row2"><td class="cell1"><div> </div></td><td class="cell2"><div> </div></td><td class="cell3"><div> </div></td><td class="cell4"><div id="courseTitle">Корпоративные информационные системы</div><div id="courseSubTitle">Языки запросов к базам данных : Практика 3. Создание  и работа с триггерами объектов и событий</div></td></tr></table></td></tr><tr><td id="contentOuter"><table id="contentInner"><tr><td class="menuOuter"><table class="menuInner"><tr><td><ul class="level0"><li><a href="../../00/styles/courses.html">Содержание курса</a></li><li><span>Теория</span></li><ul class="level1"><li><a href="../../03/content/content1.html">Оптимизация запросов</a></li><li><a href="../../03/content/content2.html">Окружение 4-го поколения</a></li><li><a href="../../03/content/content3.html">Язык PL / SQL. Общие положения </a></li><li><a href="../../03/content/content4.html">Переменные и константы. Кодовое множество</a></li><li><a href="../../03/content/content5.html">Типы данных</a></li><li><a href="../../03/content/content6.html">Команды управления</a></li><li><a href="../../03/content/content7.html">Создание хранимых процедур и функций </a></li><li><a href="../../03/content/content8.html">Параметры подпрограмм</a></li><li><a href="../../03/content/content9.html">Встроенные функции PL / SQL</a></li><li><a href="../../03/content/content10.html">Курсоры</a></li><li><a href="../../03/content/content11.html">Исключительные ситуации</a></li><li><a href="../../03/content/content12.html">Обработчики исключений </a></li><li><a href="../../03/content/content13.html">Пакеты</a></li><li><a href="../../03/content/content14.html">Триггеры объектов </a></li></ul><li><span>Практика</span></li><ul class="level1"><li><a href="../../03/content/example1.html">Практика 2. Использование подпрограмм в языках  программирования 4-го поколения</a></li><li><a href="../../03/content/example2.html">Лабораторная работа 2 Подпрограммы как средство создания серверных частей информационных систем на примере СУБД Oracle </a></li><li><a href="../../03/content/example3.html">Практика 3. Создание  и работа с триггерами объектов и событий</a></li><li><a href="../../03/content/example4.html">Лабораторная работа 3. Триггеры объектов и событий базы данных </a></li></ul><li><span>Текущий контроль знаний</span></li><ul class="level1"><li><a href="../../03/content/multiply-choice-test25.html">Управляющие структуры</a></li><li><a href="../../03/content/multiply-answers-test7.html">Подпрограммы языка PL/SQL</a></li><li><a href="../../03/content/multiply-choice-test1.html">Курсоры</a></li><li><a href="../../03/content/multiply-answers-test12.html">Исключительные ситуации</a></li><li><a href="../../03/content/multiply-choice-test19.html">Пакеты</a></li><li><a href="../../03/content/multiply-answers-test3.html">Триггеры</a></li></ul><li><a href="../../03/styles/glossary.html">Словарь терминов</a></li><li><a href="../../03/03.pdf" target="_blank">Версия для печати</a></li></ul></td></tr></table></td><td class="content"><div id="content"><div id="topBlankStripe"> </div><span id="lnkb40633f8e4b44d5faca6a996d23a645a"> </span><h1 align="left" class="headline-source">     Практика 3. Создание  и работа с триггерами объектов и событий</h1><span id="lnke15d4187cd6341809eb0423560b0b353"> </span><div class="section"><p align="justify" class="paragraph-source">      Во многих случаях триггеры дополняют стандартные возможности ORACLE, способствуя созданию гибко настраиваемой системы управления базой данных. </p><p align="justify" class="paragraph-source">     Например, триггер может позволять операции DML по таблице лишь тогда, когда они предпринимаются в нормальные рабочие часы. Итак, стандартные средства защиты ORACLE, роли и привилегии, контролируют, какие пользователи могут выдавать предложения DML для таблицы; в дополнение к этому, триггер еще более ограничивает операции DML, следя за тем, чтобы они выполнялись в определенное время. Это лишь один из способов, как вы можете использовать триггеры для настройки управления информацией в базе данных ORACLE. </p><p align="justify" class="paragraph-source">     Помимо этого, триггеры обычно используются для: </p><p align="justify" class="paragraph-source">     - автоматической генерации значений вычисляемых столбцов; </p><p align="justify" class="paragraph-source">     - предотвращения незаконных транзакций; </p><p align="justify" class="paragraph-source">     - ввода в действие комплексных правил защиты; </p><p align="justify" class="paragraph-source">     - обеспечения ссылочной целостности между узлами в распределенной базе данных; </p><p align="justify" class="paragraph-source">     - реализации сложных организационных правил; </p><p align="justify" class="paragraph-source">     - прозрачной регистрации событий; </p><p align="justify" class="paragraph-source">     - изощренного аудитинга; </p><p align="justify" class="paragraph-source">     - поддержания синхронных дублирований таблиц; </p><p align="justify" class="paragraph-source">     - сбора статистики по обращениям к таблице.</p></div><span id="lnk4708f5ec85b74302a343caab8ef5a58b"> </span><h2 align="left" class="paragraph-headline-source">     Каскадные триггеры</h2><span id="lnkf6903f36138b4451a66d44af78bcd4be"> </span><table class="note"><tr><td><p align="left" class="note-source">     Создать триггер каскадного изменения записей.</p><p align="left" class="note-source">     Таблица DEPARTMENTS и GOODS (а также таблица WORKERS) связаны между собой по полю Dept_id. При изменении данных этого поля в главной таблице (DEPARTMENTS) необходимо соответственно изменять данные в подчиненных таблицах (GOODS і WORKERS)</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnkb876043c30954af7823ca859073a0090"> </span><div class="section"><p align="justify" class="paragraph-source">CREATE TRIGGER CASCADE_MODIFY</p><p align="justify" class="paragraph-source">AFTER UPDATE DEPT_ID ON DEPARTMENTS</p><p align="justify" class="paragraph-source">   FOR EACH ROW </p><p align="justify" class="paragraph-source">BEGIN</p><p align="justify" class="paragraph-source">UPDATE GOODS SET DEPT_ID=:NEW.DEPT_ID</p><p align="justify" class="paragraph-source">     WHERE DEPT_ID=:OLD.DEPT_ID;</p><p align="justify" class="paragraph-source">UPDATE WORKERS SET DEPT_ID=:NEW.DEPT_ID</p><p align="left" class="paragraph-source">     WHERE DEPT_ID=:OLD.DEPT_ID;END;</p></div><span id="lnkfeab5431d9aa456d959c5aff2af82c04"> </span><table class="note"><tr><td><p align="left" class="note-source">     Создать триггер каскадного удаления записей.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnk0c1f3de8355a49ef9a04a4fcfb3a1a54"> </span><div class="section"><p align="justify" class="paragraph-source">CREATE OR REPLACE TRIGGER CASCADE_DELETE</p><p align="justify" class="paragraph-source"> BEFORE DELETE ON DEPARTMENTS</p><p align="justify" class="paragraph-source">FOR EACH ROW</p><p align="justify" class="paragraph-source">BEGIN</p><p align="justify" class="paragraph-source">DELETE FROM GOODS</p><p align="justify" class="paragraph-source">WHERE DEPT_ID=:OLD.DEPT_ID;</p><p align="justify" class="paragraph-source">DELETE FROM WORKERS</p><p align="justify" class="paragraph-source">WHERE DEPT_ID=:OLD.DEPT_ID;</p><p align="left" class="paragraph-source">END;</p></div><span id="lnkbafcb8ea9338404dac677913a5e45c02"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Обратите внимание на необходимость самостоятельно создать аналогичные триггеры (изъятия и модификации) для таблицы Goods, потому что таблицы Goods и Sales связаны между собой с использованием связи «многие-к-одному» по полю Good_id и при наличии информации о продаже товаров в таблице Sales невозможно проверить работу триггеров каскадного модифицирования и удаления. </p></td><th><img src="../../00/styles/files/note_comment.png" title="" alt="" /></th></tr></table><span id="lnkf8fdeb22bbcd4a208835bbc50dfa2071"> </span><div class="section"><p align="left" class="paragraph-source">     Результат работы  триггера каскадного изменения показаны на рисунке 14</p></div><span id="lnk0999c43312e34d94a4c942e0e4ceccf6"> </span><div class="section"><p align="center" class="paragraph-source"><img src="../res/files/jpg599_0_.jpg" height="320px" width="744px" alt="" /> </p><p align="center" class="paragraph-source">     Рисунок 14 - Результат работы триггера каскадного изменения связанных строк</p></div><span id="lnkdddee1f32536400986bdab30cf7a0c17"> </span><h2 align="left" class="paragraph-headline-source">     Просмотр информации о существующих триггерах</h2><span id="lnke383527a10304c22a775d9b49d7f702f"> </span><div class="section"><p align="justify" class="paragraph-source">     Такие представления словаря данных раскрывают информацию о триггеры:</p><p align="justify" class="paragraph-source">     - USER_TRIGGERS;</p><p align="justify" class="paragraph-source">     - ALL_TRIGGERS;</p><p align="justify" class="paragraph-source">     - DBA_TRIGGERS.</p><p align="justify" class="paragraph-source">     Если известно имя триггера (может быть получен выборкой из словаря данных), то можно использовать такие запросы, которые возвращают информацию о триггер TR1:</p><p align="justify" class="paragraph-source">SELECT type, triggering_statement, table_name</p><p align="justify" class="paragraph-source">    FROM user_triggers</p><p align="justify" class="paragraph-source">    WHERE name = 'TR1';</p><p align="justify" class="paragraph-source">     Данный запрос возвращает информацию из представления USER_TRIGGERS о типе триггера (табличный триггер или триггер строки и его действия), о предложении триггера и название таблицы, которой принадлежит триггер TR1.</p><p align="justify" class="paragraph-source">SELECT trigger_body</p><p align="justify" class="paragraph-source">    FROM user_triggers</p><p align="justify" class="paragraph-source">    WHERE trigger_name = 'CASCADE_DELETE';</p><p align="justify" class="paragraph-source">     С помощью запроса,  показанного на рисунке 15,  можно просмотреть тело триггера.     </p></div><span id="lnkc67d20f9b53744a689ad6d74dbd31123"> </span><div class="section"><p align="center" class="paragraph-source"><img src="../res/files/jpg59b_0_.jpg" height="296px" width="413px" alt="" /> </p><p align="center" class="paragraph-source">Рисунок 15 - Просмотр из словаря данных</p></div><span id="lnkc8bef35b218b42dc83146fc11a463bec"> </span><h2 align="left" class="paragraph-headline-source">     Триггеры и комплексные проверки полномочий</h2><span id="lnk3ba345eee9fc4a629479c479f66295d6"> </span><div class="section"><p align="justify" class="paragraph-source">     Триггеры часто используются для реализации сложных проверок защиты данных таблицы. Используйте триггеры только для таких проверок полномочий, которые нельзя выполнить с помощью стандартных средств защиты базы данных в ORACLE. </p></div><span id="lnk3d6a1945317145328f959827ac181807"> </span><div class="section"><p align="justify" class="paragraph-source">     Лучше всего для комплексной проверки полномочий использовать триггер предложения BEFORE. Это дает следующие преимущества: </p><p align="justify" class="paragraph-source">     - Контроль осуществляется до исполнения предложения триггера, так что не придется отменять выполненную работу, если предложение будет подвергнуто откату.</p><p align="justify" class="paragraph-source">      - Контроль осуществляется лишь один раз для предложения триггера, а не по каждой строке, затрагиваемой этим предложением. </p></div><span id="lnk8de4a126c39e45e285d65ec2d4263547"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Написать триггер запрета проведения операций по торговле во время выходных дней, а также в нерабочие часы.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnk27546f7ea6c64a75bd6f6c4f184ab1a7"> </span><div class="section"><p align="justify" class="paragraph-source">CREATE or REPLACE TRIGGER goods_work </p><p align="justify" class="paragraph-source">BEFORE INSERT OR DELETE OR UPDATE ON goods </p><p align="justify" class="paragraph-source">DECLARE </p><p align="justify" class="paragraph-source">not_on_weekends EXCEPTION; </p><p align="justify" class="paragraph-source">non_working_hours EXCEPTION; </p><p align="justify" class="paragraph-source">BEGIN </p><p align="justify" class="paragraph-source">/* проверить на выходные дни */ </p><p align="justify" class="paragraph-source">IF ((To_char(sysdate, 'DY') = 'SAT') OR (To_char(sysdate, 'DY') = 'SUN')) THEN </p><p align="justify" class="paragraph-source">RAISE not_on_weekends; </p><p align="justify" class="paragraph-source">END IF; </p><p align="justify" class="paragraph-source">/* Проверить на  рабочие часы (8am .. 6pm) */ </p><p align="justify" class="paragraph-source">IF ((To_char(sysdate, 'HH24') &lt; 8) OR (To_char(sysdate, 'HH24') &gt; 18)) THEN </p><p align="justify" class="paragraph-source">RAISE non_working_hours; </p><p align="justify" class="paragraph-source">END IF; </p><p align="justify" class="paragraph-source">EXCEPTION </p><p align="justify" class="paragraph-source">WHEN not_on_weekends THEN </p><p align="justify" class="paragraph-source">raise_application_error (-20324, 'May not change quantity of goods during the weekend'); </p><p align="justify" class="paragraph-source">WHEN non_working_hours THEN </p><p align="justify" class="paragraph-source">raise_application_error (-20326, 'May not change quantity of goods during non-working hours'); </p><p align="justify" class="paragraph-source">END;</p><p align="justify" class="paragraph-source">/</p></div><span id="lnk773e49835ac047b58fabce18cd31bfc3"> </span><div class="section"><p align="left" class="paragraph-source">     Результат работы триггера  показан на рисунке 16 </p></div><span id="lnk536331a960c14233a49cac7172b6f0f7"> </span><div class="section"><p align="center" class="paragraph-source"><img src="../res/files/jpg5bf_0_.jpg" height="200px" width="599px" alt="" /> </p><p align="center" class="paragraph-source">     Рисунок 16 - Результат работы триггера</p></div><span id="lnk4bfdce412d344355b002ac79fcc1783a"> </span><h2 align="left" class="paragraph-headline-source">     Аудит с помощью триггеров</h2><span id="lnkdffb8660fce843da82428511543b26b2"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Нам необходима информация, когда обращаются к таблице Goods , и какие типы запросов выдаются. Следующий пакет и триггер отслеживает эту информацию по часам и типам действий (например, UPDATE, DELETE или INSERT) по таблице Goods . Глобальная переменная сессии ITOG .ROW_ OPER инициализируется нулевым значением триггером предложения BEFORE, затем наращивается при каждом выполнении триггера строки, и, наконец, накопленная статистика сохраняется в таблице ITOG _TAB триггером предложения AFTER. </p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnkf453278cf04943e28a740178031ca9bc"> </span><div class="section"><p align="left" class="paragraph-source">CREATE TABLE itog_tab </p><p align="left" class="paragraph-source">(oper_type VARCHAR2(10), </p><p align="left" class="paragraph-source">row_oper INTEGER, </p><p align="left" class="paragraph-source">Time_oper VARCHAR2(20)); </p><p align="left" class="paragraph-source">CREATE OR REPLACE PACKAGE itog IS </p><p align="left" class="paragraph-source">Row_oper INTEGER; </p><p align="left" class="paragraph-source">END; </p><p align="left" class="paragraph-source">/ </p><p align="left" class="paragraph-source">CREATE TRIGGER T1 </p><p align="left" class="paragraph-source">BEFORE UPDATE OR DELETE OR INSERT ON Goods </p><p align="left" class="paragraph-source">BEGIN </p><p align="left" class="paragraph-source">itog.row_oper:= 0; </p><p align="left" class="paragraph-source">END; </p><p align="left" class="paragraph-source">/ </p></div><span id="lnk2eecb36c513d46759aa521fb7d103962"> </span><div class="section"><p align="left" class="paragraph-source">CREATE TRIGGER T2 </p><p align="left" class="paragraph-source">BEFORE UPDATE OR DELETE OR INSERT ON Goods </p><p align="left" class="paragraph-source">FOR EACH ROW </p><p align="left" class="paragraph-source">BEGIN </p><p align="left" class="paragraph-source">itog.row_oper:= itog.row_oper + 1; </p><p align="left" class="paragraph-source">END; </p><p align="left" class="paragraph-source">/ </p><p align="left" class="paragraph-source">CREATE TRIGGER T3 </p><p align="left" class="paragraph-source">AFTER UPDATE OR DELETE OR INSERT ON Goods </p><p align="left" class="paragraph-source">DECLARE </p><p align="left" class="paragraph-source">typ VARCHAR2(10); </p><p align="left" class="paragraph-source">hour VARCHAR2(20); </p><p align="left" class="paragraph-source">BEGIN </p><p align="left" class="paragraph-source">IF updating THEN </p><p align="left" class="paragraph-source">typ := 'update'; </p><p align="left" class="paragraph-source">END IF; </p><p align="left" class="paragraph-source">IF deleting THEN </p><p align="left" class="paragraph-source">typ := 'delete'; </p><p align="left" class="paragraph-source">END IF; </p><p align="left" class="paragraph-source">IF inserting THEN </p><p align="left" class="paragraph-source">typ := 'insert'; </p><p align="left" class="paragraph-source">END IF; </p><p align="left" class="paragraph-source">hour := TO_CHAR(SYSDATE, DD:MM:YY - HH:MIN:SS'); </p><p align="left" class="paragraph-source">INSERT INTO itog_tab VALUES (itog.row_oper, typ, hour); </p><p align="left" class="paragraph-source">END; </p><p align="left" class="paragraph-source">/ </p></div><span id="lnkcc59a7acc7b34d92b52f1f6186d9f77f"> </span><h2 align="left" class="paragraph-headline-source">     Задачи для самостоятельного выполнения</h2><span id="lnk30339eff13c0428d8ec86f423c98a47b"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Разработайте триггер копирования каждой второй удаляемой строки.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnk9920978cbee14d7ca0c8c45b6998ed49"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Разработайте триггер копирования каждой третьей изменяемой строк.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnkd8942b171b69444f8790a5d6bd491734"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Разработайте триггер, с помощью которого можно при покупке оставлять хотя бы один товар (уменьшить количество товаров до 0 нельзя).</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnk8f1dc3b8f2a740eb86af88080073055d"> </span><table class="note"><tr><td><p align="justify" class="note-source">     Разработайте триггер ограничения изменения цены, например, с увеличением цены более чем на 50%, применить лишь 50% увеличения цены.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnk73fce5984f8e4499b78be92ae7453eb2"> </span><table class="note"><tr><td><p align="justify" class="note-source">     С помощью триггера запретить добавление товара, если в том же отделе уже есть товары общей стоимостью более чем 10000.</p></td><th><img src="../../00/styles/files/note_problem.png" title="Проблемма" alt="Проблемма" /></th></tr></table><span id="lnke072c099cfcf4185bd2f8df9b13d43bd"> </span><div class="section"><p align="justify" class="paragraph-source">     Далее следует выполнить <a title="" target="_self" href="../../03/content/example4.html#lnk37b7250842564923933a2016ba5c0640">лабораторную работу 3</a></p></div></div></td></tr></table></td></tr><tr><td id="bottomOuter"><table id="bottomInner"><tr><td class="cell1"><div> </div></td><td class="cell2"><div>© 2012 ХНУРЭ, ПИ, Широкопетлева М.С., <a href="mailto:mshirokopetleva@gmail.com">mshirokopetleva@gmail.com</a>;   ХНУРЭ, ПИ, Черепанова Ю.Ю.;   ХНУРЭ, ПИ, Мазурова О.А.<br /><a href="http://lersus.de/" title="Данный курс создан с помощью авторской системы LERSUS" target="_blank">Разработано с помощью LERSUS</a></div></td></tr></table></td></tr></table></body></html>